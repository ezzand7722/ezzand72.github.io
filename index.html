    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Audio Trimmer</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.6.3/wavesurfer.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <script src="https://unpkg.com/vexflow/releases/vexflow-min.js"></script>
        <script src="https://unpkg.com/soundfont-player"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 48rem;
                margin: 0 auto;
                padding: 20px;
                background: linear-gradient(135deg, #1a1e2e, #2c3041);
                color: #e5e7eb;
                background-image: 
                    radial-gradient(circle at 25px 25px, rgba(168, 85, 247, 0.15) 2%, transparent 0%),
                    radial-gradient(circle at 75px 75px, rgba(168, 85, 247, 0.1) 2%, transparent 0%);
                background-size: 100px 100px;
                position: relative;
                overflow-x: hidden;
            }

            body::before {
                content: '♪';
                position: fixed;
                top: 15%;
                left: 15%;
                font-size: 60px;
                color: rgba(168, 85, 247, 0.1);
                animation: float 8s ease-in-out infinite;
            }

            body::after {
                content: '♫';
                position: fixed;
                bottom: 15%;
                right: 15%;
                font-size: 80px;
                color: rgba(168, 85, 247, 0.1);
                animation: float 6s ease-in-out infinite reverse;
            }

            @keyframes float {
                0%, 100% {
                    transform: translateY(0) rotate(0deg);
                }
                50% {
                    transform: translateY(-20px) rotate(10deg);
                }
            }

            .container {
                background: rgba(31, 41, 55, 0.95);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(168, 85, 247, 0.1);
                padding: 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            }

            .container:hover {
                box-shadow: 0 8px 32px rgba(168, 85, 247, 0.15);
                transition: box-shadow 0.3s ease;
            }

            h1 {
                color: #a855f7;
                text-align: center;
                margin-bottom: 1.5rem;
            }

            .upload-area {
                border: 2px dashed #374151;
                border-radius: 0.5rem;
                padding: 3rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s;
                background: #1f2937;
            }

            .upload-area:hover {
                border-color: #a855f7;
                background: rgba(168, 85, 247, 0.1);
            }

            .upload-icon {
                height: 3rem;
                width: 3rem;
                margin: 0 auto;
                color: #9ca3af;
            }

            #waveform {
                margin-top: 1rem;
                border-radius: 0.5rem;
                overflow: hidden;
                background: #374151;
            }

            .controls {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 1rem;
                padding: 0.5rem;
                background: #2d3748;
                border-radius: 0.5rem;
            }

            .controls button {
                min-width: 100px;
                justify-content: center;
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                transition: all 0.2s ease;
                background: #4b5563;
                color: #e5e7eb;
            }

            button.outline {
                background: transparent;
                border: 1px solid #4b5563;
                color: #e5e7eb;
            }

            button.outline:hover {
                background: #374151;
                border-color: #a855f7;
                color: #a855f7;
            }

            .controls button.delete:hover {
                background: #dc2626;
            }

            button {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 0.375rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }

            button i {
                font-size: 1rem;
            }

            button.primary {
                background: #a855f7;
                color: white;
            }

            button.outline {
                background: transparent;
                border: 1px solid #e5e7eb;
                color: #374151;
            }

            button:hover {
                opacity: 0.9;
            }

            .range-slider {
                margin-top: 1.5rem;
                position: relative;
                height: 1.75rem;
                touch-action: none;
                -webkit-user-select: none;
                user-select: none;
            }

            .range-track {
                height: 0.25rem;
                width: 100%;
                background: #4b5563;
                border-radius: 9999px;
                position: relative;
                top: 50%;
                transform: translateY(-50%);
            }

            .range-selection {
                position: absolute;
                height: 100%;
                background: #a855f7;
            }

            .range-handle {
                width: 1.25rem;
                height: 1.25rem;
                background: #2d3748;
                border-radius: 50%;
                position: absolute;
                top: 50%;
                transform: translate(-50%, -50%);
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                cursor: ew-resize;
                touch-action: none;
                -webkit-user-select: none;
                user-select: none;
                border: 2px solid #a855f7;
            }

            .range-handle::after {
                content: '';
                width: 0.5rem;
                height: 0.5rem;
                background: #a855f7;
                border-radius: 50%;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }

            .time-display {
                display: flex;
                justify-content: space-between;
                margin-top: 0.5rem;
                font-size: 0.875rem;
                color: #a855f7;
            }

            #audioInput {
                display: none;
            }

            button.delete {
                background: #991b1b;
                color: #e5e7eb;
            }

            .deleted-region {
                position: absolute;
                height: 100%;
                background: rgba(239, 68, 68, 0.2);
                pointer-events: none;
            }

            button.outline:hover {
                background: #f3f4f6;
            }

            .musical-note-1 {
                content: '♩';
                position: fixed;
                top: 30%;
                right: 20%;
                font-size: 50px;
                color: rgba(168, 85, 247, 0.08);
                animation: floatRotate 7s ease-in-out infinite;
            }

            .musical-note-2 {
                content: '♬';
                position: fixed;
                bottom: 40%;
                left: 25%;
                font-size: 70px;
                color: rgba(168, 85, 247, 0.12);
                animation: floatRotate 9s ease-in-out infinite reverse;
            }

            .musical-note-3 {
                content: '♪';
                position: fixed;
                top: 60%;
                right: 30%;
                font-size: 45px;
                color: rgba(168, 85, 247, 0.1);
                animation: float 10s ease-in-out infinite;
            }

            @keyframes floatRotate {
                0%, 100% {
                    transform: translateY(0) rotate(0deg);
                }
                50% {
                    transform: translateY(-30px) rotate(15deg);
                }
            }

            @keyframes pulse {
                0%, 100% {
                    opacity: 0.1;
                }
                50% {
                    opacity: 0.3;
                }
            }

            .loading-message {
                text-align: center;
                margin-top: 1rem;
                padding: 1rem;
                background: rgba(168, 85, 247, 0.1);
                border-radius: 0.5rem;
            }

            .loading-message small {
                display: block;
                margin-top: 0.5rem;
                color: #9ca3af;
            }

            .processing-steps {
                margin-top: 1rem;
                text-align: left;
                padding: 1rem;
                background: rgba(0, 0, 0, 0.1);
                border-radius: 0.5rem;
            }

            .step {
                margin: 0.5rem 0;
                color: #a855f7;
            }
        </style>
    </head>
    <body>
        <div class="musical-note-1">♩</div>
        <div class="musical-note-2">♬</div>
        <div class="musical-note-3">♪</div>

        <div class="container">
            <h1>Audio Trimmer</h1>
            
            <div class="upload-area" onclick="document.getElementById('audioInput').click()">
                <p>Click or drag audio file here</p>
                <input type="file" id="audioInput" accept="audio/*">
            </div>

            <div id="waveform"></div>

            <div class="range-slider">
                <div class="range-track">
                    <div class="range-selection"></div>
                    <div class="range-handle left"></div>
                    <div class="range-handle right"></div>
                </div>
            </div>

            <div class="time-display">
                <span id="startTime">00:00</span>
                <span id="endTime">00:00</span>
            </div>

            <div class="controls">
                <button onclick="playSelection()">
                    <i class="fas fa-play"></i>
                    Play
                </button>
                <button onclick="restartAudio()" class="outline">
                    <i class="fas fa-redo"></i>
                    Restart
                </button>
                <button onclick="deleteSelection()" class="delete">
                    <i class="fas fa-scissors"></i>
                    Cut
                </button>
                <button onclick="undoLastChange()" class="outline">
                    <i class="fas fa-undo"></i>
                    Undo
                </button>
                <button onclick="saveAudio()">
                    <i class="fas fa-download"></i>
                    Save
                </button>
                <button onclick="document.getElementById('sheetInput').click()" class="outline">
                    <i class="fas fa-music"></i>
                    Read Sheet Music
                </button>
            </div>
        </div>

        <input type="file" id="sheetInput" accept="image/*" style="display: none;">

        <script>
            let wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#4b5563',
                progressColor: '#a855f7',
                cursorColor: '#a855f7',
                height: 128,
                responsive: true,
                barWidth: 2,
                barGap: 1
            });

            const rangeSlider = document.querySelector('.range-slider');
            const rangeSelection = document.querySelector('.range-selection');
            const leftHandle = document.querySelector('.range-handle.left');
            const rightHandle = document.querySelector('.range-handle.right');

            document.getElementById('audioInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                wavesurfer.loadBlob(file);
            });

            let startPosition = 0;
            let endPosition = 1;
            let deletedRegions = [];
            let audioBuffer = null;
            let audioHistory = [];
            const MAX_HISTORY = 10;
            let isPlaying = false;

            wavesurfer.on('ready', function() {
                startPosition = 0;
                endPosition = 1;
                updateRangeSelection();
                document.getElementById('endTime').textContent = formatTime(wavesurfer.getDuration());
                audioBuffer = wavesurfer.backend.buffer.slice(0); // Create a copy of the buffer
                deletedRegions = [];
                audioHistory = []; // Reset history when loading new audio
            });

            function formatTime(seconds) {
                return new Date(seconds * 1000).toISOString().substr(14, 5);
            }

            function updateRangeSelection() {
                const width = rangeSlider.offsetWidth;
                const leftPos = startPosition * width;
                const rightPos = endPosition * width;
                
                rangeSelection.style.left = `${leftPos}px`;
                rangeSelection.style.width = `${rightPos - leftPos}px`;
                leftHandle.style.left = `${leftPos}px`;
                rightHandle.style.left = `${rightPos}px`;

                const duration = wavesurfer.getDuration();
                document.getElementById('startTime').textContent = formatTime(startPosition * duration);
                document.getElementById('endTime').textContent = formatTime(endPosition * duration);
            }

            [leftHandle, rightHandle].forEach(handle => {
                handle.addEventListener('mousedown', initDrag);
                handle.addEventListener('touchstart', initDrag, { passive: false });

                function initDrag(e) {
                    e.preventDefault();
                    const isLeft = handle === leftHandle;
                    const initialX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                    const initialPos = isLeft ? startPosition : endPosition;
                    const width = rangeSlider.offsetWidth;

                    function onMove(e) {
                        const currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                        const delta = (currentX - initialX) / width;
                        let newPos = initialPos + delta;
                        newPos = Math.max(0, Math.min(1, newPos));

                        if (isLeft) {
                            if (newPos < endPosition) {
                                startPosition = newPos;
                                wavesurfer.seekTo(startPosition);
                            }
                        } else {
                            if (newPos > startPosition) {
                                endPosition = newPos;
                            }
                        }
                        updateRangeSelection();
                    }

                    function onEnd() {
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onEnd);
                        document.removeEventListener('touchmove', onMove);
                        document.removeEventListener('touchend', onEnd);
                    }

                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onEnd);
                    document.addEventListener('touchmove', onMove, { passive: false });
                    document.addEventListener('touchend', onEnd);
                }
            });

            function playSelection() {
                const duration = wavesurfer.getDuration();
                if (!isPlaying) {
                    // If not playing, start from current position
                    wavesurfer.play();
                } else {
                    wavesurfer.pause();
                }
                isPlaying = !isPlaying;
                
                // Update play button icon
                const playButton = document.querySelector('button i.fa-play, button i.fa-pause');
                playButton.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
            }

            async function trimAudio() {
                const duration = wavesurfer.getDuration();
                const startTime = startPosition * duration;
                const endTime = endPosition * duration;
                
                // Get the audio data
                const audioData = wavesurfer.backend.buffer;
                const sampleRate = audioData.sampleRate;
                const startOffset = Math.floor(startTime * sampleRate);
                const endOffset = Math.floor(endTime * sampleRate);
                const frameCount = endOffset - startOffset;
                
                // Create new buffer for trimmed audio
                const trimmedBuffer = new AudioContext().createBuffer(
                    audioData.numberOfChannels,
                    frameCount,
                    sampleRate
                );
                
                // Copy the trimmed portion
                for (let channel = 0; channel < audioData.numberOfChannels; channel++) {
                    const channelData = audioData.getChannelData(channel);
                    const trimmedData = trimmedBuffer.getChannelData(channel);
                    for (let i = 0; i < frameCount; i++) {
                        trimmedData[i] = channelData[i + startOffset];
                    }
                }
                
                // Convert to WAV and download
                const wav = audioBufferToWav(trimmedBuffer);
                const blob = new Blob([wav], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'trimmed_audio.wav';
                a.click();
                URL.revokeObjectURL(url);
            }

            // Helper function to convert AudioBuffer to WAV format
            function audioBufferToWav(buffer) {
                const interleaved = new Float32Array(buffer.length);
                const channelData = buffer.getChannelData(0);
                for (let i = 0; i < buffer.length; i++) {
                    interleaved[i] = channelData[i];
                }
                
                const dataView = new DataView(new ArrayBuffer(44 + interleaved.length * 2));
                const writeString = (view, offset, string) => {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                };

                writeString(dataView, 0, 'RIFF');
                dataView.setUint32(4, 36 + interleaved.length * 2, true);
                writeString(dataView, 8, 'WAVE');
                writeString(dataView, 12, 'fmt ');
                dataView.setUint32(16, 16, true);
                dataView.setUint16(20, 1, true);
                dataView.setUint16(22, 1, true);
                dataView.setUint32(24, buffer.sampleRate, true);
                dataView.setUint32(28, buffer.sampleRate * 2, true);
                dataView.setUint16(32, 2, true);
                dataView.setUint16(34, 16, true);
                writeString(dataView, 36, 'data');
                dataView.setUint32(40, interleaved.length * 2, true);

                const volume = 0.5;
                for (let i = 0; i < interleaved.length; i++) {
                    const sample = Math.max(-1, Math.min(1, interleaved[i]));
                    dataView.setInt16(44 + i * 2, sample * 0x7FFF * volume, true);
                }

                return dataView.buffer;
            }

            async function deleteSelection() {
                if (!wavesurfer) return;
                
                // Stop playback if playing
                if (isPlaying) {
                    wavesurfer.pause();
                    isPlaying = false;
                    const playButton = document.querySelector('button i.fa-play, button i.fa-pause');
                    playButton.className = 'fas fa-play';
                }
                
                const duration = wavesurfer.getDuration();
                const startTime = startPosition * duration;
                const endTime = endPosition * duration;
                
                // Get the current buffer directly from wavesurfer
                const currentBuffer = wavesurfer.backend.buffer;
                
                // Save current state to history
                audioHistory.push(currentBuffer);
                if (audioHistory.length > MAX_HISTORY) {
                    audioHistory.shift();
                }
                
                // Create new buffer without the selected region
                const sampleRate = currentBuffer.sampleRate;
                const numberOfChannels = currentBuffer.numberOfChannels;
                
                // Calculate new duration
                const newDuration = duration - (endTime - startTime);
                const newBuffer = new AudioContext().createBuffer(
                    numberOfChannels,
                    Math.floor(newDuration * sampleRate),
                    sampleRate
                );
                
                // Copy audio data, excluding the selected region
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    const channelData = currentBuffer.getChannelData(channel);
                    const newChannelData = newBuffer.getChannelData(channel);
                    
                    const startOffset = Math.floor(startTime * sampleRate);
                    const endOffset = Math.floor(endTime * sampleRate);
                    
                    let writeIndex = 0;
                    
                    // Copy first part (before selection)
                    for (let i = 0; i < startOffset; i++) {
                        newChannelData[writeIndex] = channelData[i];
                        writeIndex++;
                    }
                    
                    // Skip the selected region and copy the rest
                    for (let i = endOffset; i < channelData.length; i++) {
                        newChannelData[writeIndex] = channelData[i];
                        writeIndex++;
                    }
                }
                
                // Load the new buffer into wavesurfer
                wavesurfer.loadDecodedBuffer(newBuffer);
                
                // Reset positions
                startPosition = 0;
                endPosition = 1;
                updateRangeSelection();
            }

            async function saveAudio() {
                if (!audioBuffer) return;
                
                const wav = audioBufferToWav(audioBuffer);
                const blob = new Blob([wav], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'edited_audio.wav';
                a.click();
                URL.revokeObjectURL(url);
            }

            function restartAudio() {
                if (wavesurfer) {
                    wavesurfer.stop();
                    isPlaying = false;
                    // Update play button icon
                    const playButton = document.querySelector('button i.fa-play, button i.fa-pause');
                    playButton.className = 'fas fa-play';
                }
            }

            function undoLastChange() {
                if (audioHistory.length > 0) {
                    // Stop playback if playing
                    if (isPlaying) {
                        wavesurfer.pause();
                        isPlaying = false;
                        const playButton = document.querySelector('button i.fa-play, button i.fa-pause');
                        playButton.className = 'fas fa-play';
                    }
                    
                    // Get the last state
                    audioBuffer = audioHistory.pop();
                    
                    // Load the previous state
                    wavesurfer.loadDecodedBuffer(audioBuffer);
                    
                    // Reset positions
                    startPosition = 0;
                    endPosition = 1;
                    updateRangeSelection();
                }
            }

            async function processSheetMusic(file) {
                const loadingMsg = document.createElement('div');
                loadingMsg.className = 'loading-message';
                
                try {
                    loadingMsg.innerHTML = `
                        <p>Processing sheet music...</p>
                        <div class="processing-steps">
                            <div class="step">1. Uploading Image ⏳</div>
                            <div class="step">2. Analyzing Score ⏳</div>
                            <div class="step">3. Generating Audio ⏳</div>
                        </div>
                    `;
                    document.querySelector('.container').appendChild(loadingMsg);

                    const formData = new FormData();
                    formData.append('sheet_music', file);

                    console.log('Sending request to server...');
                    
                    const response = await fetch('http://localhost:3000/api/process-sheet-music', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to process sheet music');
                    }

                    const result = await response.json();
                    console.log('Received response:', result);

                    // Update step 1
                    loadingMsg.querySelector('.step:nth-child(1)').innerHTML += ' ✓';
                    
                    // Display the recognized sheet music
                    await displayRecognizedNotes(result.notes);
                    loadingMsg.querySelector('.step:nth-child(2)').innerHTML += ' ✓';
                    
                    // Create the audio player
                    const player = await createAudioFromNotes(result.notes);
                    loadingMsg.querySelector('.step:nth-child(3)').innerHTML += ' ✓';
                    
                    // Add playback controls
                    addPlaybackControls(player);

                    // Remove loading message after a short delay
                    setTimeout(() => {
                        loadingMsg.remove();
                    }, 2000);

                } catch (error) {
                    console.error('Error:', error);
                    loadingMsg.innerHTML = `
                        <p style="color: #dc2626;">Error: ${error.message}</p>
                        <small>Please try again with a different image.</small>
                    `;
                }
            }

            function displayRecognizedNotes(notes) {
                const scoreDisplay = document.createElement('div');
                scoreDisplay.className = 'score-display';
                
                const VF = Vex.Flow;
                const div = document.createElement('div');
                const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
                renderer.resize(800, 200);
                const context = renderer.getContext();
                
                // Create a stave
                const stave = new VF.Stave(10, 40, 750);
                stave.addClef('treble').addTimeSignature('4/4');
                stave.setContext(context).draw();
                
                // Convert notes to VexFlow format
                const vfNotes = notes.map(note => {
                    return new VF.StaveNote({
                        clef: "treble",
                        keys: note.pitch,
                        duration: note.duration
                    });
                });
                
                // Create a voice and add notes
                const voice = new VF.Voice({num_beats: 4, beat_value: 4});
                voice.addTickables(vfNotes);
                
                // Format and draw
                new VF.Formatter().joinVoices([voice]).format([voice], 750);
                voice.draw(context, stave);
                
                scoreDisplay.appendChild(div);
                document.querySelector('.container').appendChild(scoreDisplay);
            }

            async function createAudioFromNotes(notes) {
                const ac = new AudioContext();
                const player = new Soundfont.Player(ac);
                
                // Load a piano soundfont
                const instrument = await player.load('acoustic_grand_piano');
                
                let isPlaying = false;
                let currentTime = 0;
                
                return {
                    play: () => {
                        if (isPlaying) return;
                        isPlaying = true;
                        
                        notes.forEach(note => {
                            instrument.play(note.pitch, ac.currentTime + note.time, {
                                duration: note.duration,
                                gain: note.velocity / 127
                            });
                        });
                    },
                    stop: () => {
                        if (!isPlaying) return;
                        isPlaying = false;
                        instrument.stop();
                    },
                    seek: (time) => {
                        currentTime = time;
                        if (isPlaying) {
                            this.stop();
                            this.play();
                        }
                    }
                };
            }

            function addPlaybackControls(player) {
                const controls = document.createElement('div');
                controls.className = 'playback-controls';
                controls.innerHTML = `
                    <button class="play-btn">
                        <i class="fas fa-play"></i>
                        Play Score
                    </button>
                    <button class="stop-btn">
                        <i class="fas fa-stop"></i>
                        Stop
                    </button>
                `;
                
                controls.querySelector('.play-btn').onclick = () => player.play();
                controls.querySelector('.stop-btn').onclick = () => player.stop();
                
                document.querySelector('.container').appendChild(controls);
            }

            document.getElementById('sheetInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    processSheetMusic(file);
                }
            });
        </script>
    </body>
    </html> 
